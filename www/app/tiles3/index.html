
<!DOCTYPE html>
<html>
<head>
  <title>Bol d'or</title>

  <link rel="stylesheet" href="//leafletjs.com/dist/leaflet.css" />
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="../bower_components/sidebar-v2/css/leaflet-sidebar.css" />
  <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.css" />
  <!--[if lte IE 8]>
    <link rel="stylesheet" href="/static/leaflet/leaflet.ie.css" />
  <![endif]-->
  <script src="../bower_components/jquery/dist/jquery.js"></script>
  <script src="../bower_components/leaflet/dist/leaflet.js"></script>
  <script src="../bower_components/leaflet-tilelayer-geojson/TileLayer.GeoJSON.js"></script>
  <script src="../bower_components/sidebar-v2/js/leaflet-sidebar.js"></script>
  <script src="../bower_components/LeafletPlayback/dist/LeafletPlayback.js"></script>

  <style type="text/css">
  html, body, #map {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
  }
  #raceList {
    background-color: red;
  }
  #timeBar { 
    position: absolute; right:0px; top:0px; overflow-y:auto; height: 100%; background-color:rgba(255,255,255,0.5);
  }
  </style>
</head>

<body>    
  <div id="sidebar" class="sidebar collapsed">
    <!-- Nav tabs -->
    <ul class="sidebar-tabs" role="tablist">
      <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
      <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
    </ul>

    <!-- Tab panes -->
    <div class="sidebar-content active">
      <div class="sidebar-pane" id="home"></div>
      <div class="sidebar-pane" id="settings"><h1>Settings</h1></div>
    </div>
  </div>

  <div id="map" class="sidebar-map"></div>


  <script type="text/javascript">
  var map = new L.Map('map'),
    cloudmadeUrl = 'http://{s}.tiles.mapbox.com/v3/openplans.map-g4j0dszr/{z}/{x}/{y}.png',
    // cloudmadeUrl = 'http://{s}.tile.cloudmade.com/1a1b06b230af4efdbb989ea99e9841af/997/256/{z}/{x}/{y}.png',
    cloudmadeAttribution = 'Map data &copy; OpenStreetMap contributors, Anemomind';
  
  map.setView(new L.LatLng(46.4, 6.5), 10);

  var baseLayer = new L.TileLayer(cloudmadeUrl, { attribution: cloudmadeAttribution});
  map.addLayer(baseLayer);

  var normalStyle = {
    "clickable": true,
    "color": "#0AF",
    "weight": 5,
    "opacity": 0.5
  };
  var hoverStyle = {
    "opacity": 0.5,
    "color": "#d10046",
  };

  var geoJSONPath = {};
  var geoJSONObjects = [];
  var tileLeftToBeLoaded = 0;
  var singleRace = false;
  var playback;

        // Playback options
      var playbackOptions = {
          playControl: true,
          dateControl: true,
          sliderControl: true,        
      };
      
      // Initialize playback
      playback = new L.Playback(map, null, null, playbackOptions);

  var geojsonURL = '../api/tilesGeoJSON/{z}/{x}/{y}/Irene';
  var geojsonTileLayer = new L.TileLayer.GeoJSON(geojsonURL, {
      clipTiles: true,
      unique: function (feature) { 

        if (singleRace) {
          geoJSONObjects.push(feature);
        }
        return feature.id;
      }
    }, {
      style: normalStyle,
      onEachFeature: function (feature, layer) {
        if (feature.properties) {
          var popupString = '<div class="popup">';
          for (var k in feature.properties) {
            var v = feature.properties[k];
            popupString += k + ': ' + v + '<br />';
          }
          popupString += '</div>';
          layer.bindPopup(popupString);
        }
        if (!(layer instanceof L.Point)) {
          layer.on('mouseover', function () {
            layer.setStyle(hoverStyle);
            layer.bringToFront();
          });
          layer.on('mouseout', function () {
            layer.setStyle(normalStyle);
          });
        }
      }
    }
  );

  map.addLayer(geojsonTileLayer);

  function updateRaceList(races) {
    if (singleRace) {
      $("#home").html('<div id="back">&larr; back to race list</div>');

      // All GeoJSON tiles have been loaded
      if (tileLeftToBeLoaded === 0) {

        geoJSONObjects.sort(function(a, b) {
          if (a.properties.time[0] < b.properties.time[0]) return -1;
          if (a.properties.time[0] > b.properties.time[0]) return 1;
          return 0;
        });

        for (var o in geoJSONObjects) {
          if (!geoJSONObjects[o].geometry.coordinates) {
            continue;
          }
          for (var c in geoJSONObjects[o].geometry.coordinates) {
            geoJSONPath.geometry.coordinates.push(geoJSONObjects[o].geometry.coordinates[c].reverse());
          }
          for (var t in geoJSONObjects[o].properties.time) {
            geoJSONPath.properties.time.push(geoJSONObjects[o].properties.time[t]);
          }
        } 
        playback.setData(geoJSONPath);

      }
    } else {
      var html = "<h2>Irene's races</h2>";
      for (var i in races) {
        var race = races[i];
        var date = new Date(race[0].substring(5, 24)).toLocaleDateString('fr-CH');
        html += "<div class='raceList' id=" + race[1] + " onmouseover='javascript:map._layers[" + 
            race[1] + "].bringToFront().setStyle(hoverStyle);' onmouseout='javascript:map._layers[" + 
            race[1] + "].setStyle(normalStyle);'>" + date + " - " + race[1] + "</div>";
      }
      $("#home").html(html);
    }
  }

  var sidebar = L.control.sidebar('sidebar').addTo(map);


  function selectRace(race) {
    singleRace = true;
    geoJSONObjects = [];
    geoJSONPath = {
      type: 'Feature',
      geometry: {
        type: 'MultiPoint',
        coordinates: []
      },
      properties: {
        title: '',
        time: []
      }
    };
    var from = race._popupContent.substring(34, 53);
    var to = race._popupContent.substring(53, 72);
    geojsonURL = '../api/tilesGeoJSON/{z}/{x}/{y}/Irene/' + from + '/' + to;
    map.removeLayer(geojsonTileLayer);
    geojsonTileLayer = new L.TileLayer.GeoJSON(geojsonURL, {
        clipTiles: true,
        unique: function (feature) { 
          return feature.id;
        }
      }, {
        style: normalStyle,
        onEachFeature: function (feature, layer) {
          if (feature.properties) {
            var popupString = '<div class="popup">';
            for (var k in feature.properties) {
              var v = feature.properties[k];
              popupString += k + ': ' + v + '<br />';
            }
            popupString += '</div>';
            layer.bindPopup(popupString);
          }
          if (!(layer instanceof L.Point)) {
            layer.on('mouseover', function () {
              layer.setStyle(hoverStyle);
              layer.bringToFront();
            });
            layer.on('mouseout', function () {
              layer.setStyle(normalStyle);
            });
          }
        }
      }
    );
    map.addLayer(geojsonTileLayer);
    sidebar.close();
  }

  $(document.body).on('click', '#back' ,function(e){
    location.reload();
  });

  $(document.body).on('click', '.raceList' ,function(e){

    var race = map._layers[e.target.id];
    map.fitBounds(map._layers[e.target.id].getBounds());
    selectRace(race);

  });

  </script>
</body>
</html>