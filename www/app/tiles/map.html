<!doctype html>

<head>
  <title>Map viewer</title>
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
  <style>
    html { height: 100%; }
    body {margin: 0; width: 100%; height: 100%; overflow:hidden; position: relative;}
    #container { position:absolute; width: 100%; top:0px; bottom:200px; }
    #timeBar { position: absolute; width:90%; height:100px; bottom:0px; 
      margin-left: 5%; margin-right: 5%;
    }
    #graph { position: absolute; width:99%; height:100px; bottom:100px; }
    canvas { width:99%; height:99%; position: absolute; top:0px; }
  </style>
  <link href="graph.css" rel="stylesheet" type="text/css">
  <script src="/bower_components/d3/d3.js"></script>
  <script src="/bower_components/jquery/dist/jquery.min.js"></script>
  <script src="utils.js"></script>
  <script src="affinetransform.js"></script>
  <script src="pinchzoom.js"></script>
  <script src="TileLayer.js"></script>
  <script src="VectorTileLayer.js"></script>
  <script src="CanvasTilesRenderer.js"></script>
  <script src="timebar.js"></script>
  <script src="graph.js"></script>
</head>

<body>
  <div id = "container">
    <canvas id="viewer" width="400" height="400" style="border:solid black 3px;">
      Your browser sucks.
    </canvas>
  </div>
  <div id="graph"></div>    
  <div id="timeBar"></div>    
    <script>        
      $(document).ready(function() {
        var plotField = 'gpsSpeed';
        var graph = new Graph('#graph');
        var timeBar = new TimeBar('#timeBar', []);

        timeBar.onTimeHighlight = function(d) {
          canvasTilesRenderer.layers[1].setHighlight(d);
        };
        timeBar.onSelect = function(d) {
          canvasTilesRenderer.layers[1].selectCurve(d.curveId);
        }

    	var canvasTilesRenderer = new CanvasTilesRenderer({
            canvas: document.getElementById("viewer"),
    	    //url: function(scale, x, y) { return " http://tiles.openseamap.org/seamark/" + scale + "/" + x + "/" + y + ".png"; },
    	    url: function(scale, x, y) { 
                //return "http://0.tiles.mapbox.com/v3/openplans.map-g4j0dszr/"
                //+ scale + "/" + x + "/" + y +".png"; },
            return "http://b.tile.opencyclemap.org/cycle/" + scale + "/" + x + "/" + y + ".png"; },
            //url: function(scale, x, y) { return "http://www.mapplus.ch/mapcache/gmaps/osm_schweiz_sqlite/" + scale + "/" + x + "/" + y + ".png;" },
    	    maxNumCachedTiles: 256,
    	    onLocationChange: function(canvasTilesRenderer) {
            timeBar.setData(canvasTilesRenderer.layers[1].getTimeData());

      	    var element = document.getElementById("location"); 
            if (element) {
              var location = canvasTilesRenderer.getLocation();
              element.innerHTML =
      	        "{x:" + location.x + ",y:" + location.y + ",scale:" + location.scale+"}";
    	      }
    	    }
    	  });
     var pathLayer = canvasTilesRenderer.layers[1];

     var setCurrentTime = function(time) {
       graph.setTimeMarks([time]);
       pathLayer.setCurrentTime(time);
     };

     canvasTilesRenderer.pinchZoom.onClic = function(pos) {
       var point = pathLayer.findPointAt(
           pos.startWorldPos.x, pos.startWorldPos.y);
       if (point) {
         pathLayer.selectCurve(point.curveId);
         setCurrentTime(point.point.time);
       } else {
          pathLayer.selectCurve(undefined);
       }
     };

     graph.onTimeClick = setCurrentTime;

     pathLayer.onSelect = function(curveId) {
       graph.setData(plotField, pathLayer.getPointsForCurve(curveId));
     };
     pathLayer.onDataArrived = function() {
       if (pathLayer.selectedCurve) {
         graph.setData(plotField, pathLayer.getPointsForCurve(pathLayer.selectedCurve));
       } else {
         timeBar.setData(pathLayer.getTimeData());
       }
     }; 
    $(window).resize(function() { canvasTilesRenderer.resizeCanvas(); });
    });
    </script>
</body>
</html>
