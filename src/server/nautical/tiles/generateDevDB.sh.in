#!/bin/bash

set -e

SRC_DIR="@CMAKE_SOURCE_DIR@"
BIN_DIR="@CMAKE_BINARY_DIR@"

datasetsDir="${SRC_DIR}/datasets"
boats="Irene psaros33_Banque_Sturdza"

# Insert (or get) test user

set +e
testUserId=$(mongo --quiet anemomind-dev --eval "print(db.users.find({email:'test@anemomind.com'})[0]._id + '')")
R=$?
set -e

if [ $R -ne 0 ]; then
  mongo --quiet anemomind-dev --eval "db.users.insert({name:'Test User','provider' : 'local', 'name' : 'test', 'email' : 'test@anemomind.com', 'hashedPassword' : 'bj0zHvlC/YIzEFOU7nKwr+OHEzSzfdFA9PMmsPGnWITGHp1zlL+29oa049o6FvuR2ofd8wOx2nBc5e2n2FIIsg==', 'salt' : 'bGwuseqg/L/do6vLH2sPVA==', 'role' : 'user' });"
  testUserId=$(mongo --quiet anemomind-dev --eval "print(db.users.find({email:'test@anemomind.com'})[0]._id + '')")
fi

for i in ${boats}; do
  echo Searching boat: $i
  set +e
  boatid=$(mongo --quiet anemomind-dev --eval "print(db.boats.find({name:'${i}'})[0]._id + '')")
  R=$?
  set -e
  if [ $R -ne 0 ]; then
    mongo --quiet anemomind-dev --eval "db.boats.insert({name:'${i}','admins' : [ObjectId('${testUserId}')]})"
    boatid=$(mongo --quiet anemomind-dev --eval "print(db.boats.find({name:'${i}'})[0]._id + '')")
  fi

  echo "Processing boat log for ${i} (id ${boatid})"
  "${BIN_DIR}/src/server/nautical/nautical_processBoatLogs" "${datasetsDir}/$i"

  echo "Generating tiles for ${i}"
  "${BIN_DIR}/src/server/nautical/tiles/tiles_generateAndUpload" \
    --boatDat "${datasetsDir}/$i/processed/boat.dat" \
    --id "${boatid}" --navpath "${datasetsDir}/$i"
done
